<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Configurações Profissionais</title>
  <link rel="stylesheet" href="style-dashboard.css">
  <style>
    .config-container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .config-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .config-section h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .checkbox-group {
      margin: 15px 0;
    }
    
    .checkbox-item {
      margin: 8px 0;
      display: flex;
      align-items: center;
    }
    
    .checkbox-item input {
      margin-right: 10px;
    }
    
    .sub-options {
      margin-left: 25px;
      border-left: 2px solid #3498db;
      padding-left: 15px;
    }
    
    .save-btn {
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .save-btn:hover {
      background-color: #27ae60;
    }
  </style>
</head>
<body>
  <div class="config-container">
    <h2><i class="fas fa-cog"></i> Configurações Profissionais</h2>
    
    <div class="config-section">
      <h3>Locais de Atendimento</h3>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="local-hospital" value="Hospital">
          <label for="local-hospital">Hospital</label>
        </div>
        
        <div class="sub-options" id="hospital-options" style="display:none;">
          <div class="checkbox-item">
            <input type="checkbox" id="hospital-hgrs" value="HGRS">
            <label for="hospital-hgrs">HGRS</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="hospital-hge" value="HGE">
            <label for="hospital-hge">HGE</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="hospital-hupes" value="HUPES">
            <label for="hospital-hupes">HUPES</label>
          </div>
        </div>
        
        <div class="checkbox-item">
          <input type="checkbox" id="local-ambulatorio" value="Ambulatório">
          <label for="local-ambulatorio">Ambulatório</label>
        </div>
        
        <div class="checkbox-item">
          <input type="checkbox" id="local-clinica" value="Clínica">
          <label for="local-clinica">Clínica</label>
        </div>
        
        <div class="checkbox-item">
          <input type="checkbox" id="local-domiciliar" value="Domiciliar">
          <label for="local-domiciliar">Domiciliar</label>
        </div>
      </div>
    </div>
    
    <div class="config-section">
      <h3>Configurações de Unidades Hospitalares</h3>
      <div id="unidades-config-container">
        <p>Selecione os hospitais primeiro para configurar as unidades</p>
      </div>
    </div>
    
    <button id="saveConfig" class="save-btn"><i class="fas fa-save"></i> Salvar Configurações</button>
  </div>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { doc, getDoc, setDoc, arrayUnion, arrayRemove, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // Elementos do DOM
    const localHospital = document.getElementById('local-hospital');
    const hospitalOptions = document.getElementById('hospital-options');
    const unidadesConfigContainer = document.getElementById('unidades-config-container');
    const saveConfigBtn = document.getElementById('saveConfig');

    // Event Listeners
    localHospital.addEventListener('change', function() {
      hospitalOptions.style.display = this.checked ? 'block' : 'none';
      if (this.checked) {
        renderUnidadesConfig();
      } else {
        unidadesConfigContainer.innerHTML = '<p>Selecione os hospitais primeiro para configurar as unidades</p>';
      }
    });

    document.querySelectorAll('input[type="checkbox"][id^="hospital-"]').forEach(checkbox => {
      checkbox.addEventListener('change', renderUnidadesConfig);
    });

    saveConfigBtn.addEventListener('click', saveConfigurations);

    // Carrega as configurações do usuário
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists()) {
          const config = userSnap.data().config || {};
          
          // Locais de atendimento
          if (config.locaisAtendimento) {
            config.locaisAtendimento.forEach(local => {
              const checkbox = document.getElementById(`local-${local.toLowerCase()}`);
              if (checkbox) checkbox.checked = true;
            });
            
            if (config.locaisAtendimento.includes("Hospital")) {
              hospitalOptions.style.display = 'block';
              
              // Hospitais selecionados
              if (config.hospitais) {
                config.hospitais.forEach(hospital => {
                  const checkbox = document.getElementById(`hospital-${hospital.toLowerCase()}`);
                  if (checkbox) checkbox.checked = true;
                });
              }
            }
          }
          
          // Renderiza configurações de unidades se houver
          if (config.hospitais && config.hospitais.length > 0) {
            renderUnidadesConfig(config.unidades);
          }
        }
      }
    });

    // Renderiza as configurações de unidades
    function renderUnidadesConfig(savedUnidades = {}) {
      const selectedHospitals = Array.from(document.querySelectorAll('input[type="checkbox"][id^="hospital-"]:checked'))
                                   .map(el => el.value);
      
      if (selectedHospitals.length === 0) {
        unidadesConfigContainer.innerHTML = '<p>Selecione os hospitais primeiro para configurar as unidades</p>';
        return;
      }
      
      let html = '';
      
      selectedHospitals.forEach(hospital => {
        html += `
          <div class="hospital-unidades">
            <h4>${hospital}</h4>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="${hospital}-uti" class="setor-checkbox" data-hospital="${hospital}" value="UTI">
                <label for="${hospital}-uti">UTI</label>
              </div>
              
              <div class="sub-options" id="${hospital}-uti-options" style="display:none;">
                <div class="checkbox-item">
                  <input type="checkbox" id="${hospital}-uti-geral1" name="${hospital}-unidades" value="UTI GERAL 1" 
                    ${savedUnidades && savedUnidades[hospital] && savedUnidades[hospital].includes("UTI GERAL 1") ? 'checked' : ''}>
                  <label for="${hospital}-uti-geral1">UTI GERAL 1</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="${hospital}-uti-geral2" name="${hospital}-unidades" value="UTI GERAL 2" 
                    ${savedUnidades && savedUnidades[hospital] && savedUnidades[hospital].includes("UTI GERAL 2") ? 'checked' : ''}>
                  <label for="${hospital}-uti-geral2">UTI GERAL 2</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="${hospital}-uti-pedi" name="${hospital}-unidades" value="UTI PEDI" 
                    ${savedUnidades && savedUnidades[hospital] && savedUnidades[hospital].includes("UTI PEDI") ? 'checked' : ''}>
                  <label for="${hospital}-uti-pedi">UTI PEDI</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="${hospital}-uti-neuro" name="${hospital}-unidades" value="UTI NEURO" 
                    ${savedUnidades && savedUnidades[hospital] && savedUnidades[hospital].includes("UTI NEURO") ? 'checked' : ''}>
                  <label for="${hospital}-uti-neuro">UTI NEURO</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="${hospital}-uti-cardio" name="${hospital}-unidades" value="UTI CARDIOVASCULAR" 
                    ${savedUnidades && savedUnidades[hospital] && savedUnidades[hospital].includes("UTI CARDIOVASCULAR") ? 'checked' : ''}>
                  <label for="${hospital}-uti-cardio">UTI CARDIOVASCULAR</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="${hospital}-uti-cirurgica" name="${hospital}-unidades" value="UTI CIRÚRGICA" 
                    ${savedUnidades && savedUnidades[hospital] && savedUnidades[hospital].includes("UTI CIRÚRGICA") ? 'checked' : ''}>
                  <label for="${hospital}-uti-cirurgica">UTI CIRÚRGICA</label>
                </div>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="${hospital}-enfermaria" class="setor-checkbox" data-hospital="${hospital}" value="Enfermaria">
                <label for="${hospital}-enfermaria">Enfermaria</label>
              </div>
            </div>
          </div>
        `;
      });
      
      unidadesConfigContainer.innerHTML = html;
      
      // Adiciona eventos aos novos checkboxes de setor
      document.querySelectorAll('.setor-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const optionsDiv = document.getElementById(`${this.dataset.hospital}-${this.value.toLowerCase()}-options`);
          if (optionsDiv) {
            optionsDiv.style.display = this.checked ? 'block' : 'none';
          }
        });
        
        // Mostra opções se já estiverem selecionadas
        if (checkbox.checked) {
          const optionsDiv = document.getElementById(`${checkbox.dataset.hospital}-${checkbox.value.toLowerCase()}-options`);
          if (optionsDiv) optionsDiv.style.display = 'block';
        }
      });
    }

    // Salva as configurações no Firebase
    async function saveConfigurations() {
      const user = auth.currentUser;
      if (!user) return;
      
      const locaisAtendimento = Array.from(document.querySelectorAll('input[type="checkbox"][id^="local-"]:checked'))
                                   .map(el => el.value);
      
      const hospitais = Array.from(document.querySelectorAll('input[type="checkbox"][id^="hospital-"]:checked'))
                           .map(el => el.value);
      
      // Coleta as unidades selecionadas por hospital
      const unidades = {};
      hospitais.forEach(hospital => {
        const hospitalUnidades = Array.from(document.querySelectorAll(`input[type="checkbox"][name="${hospital}-unidades"]:checked`))
                                   .map(el => el.value);
        if (hospitalUnidades.length > 0) {
          unidades[hospital] = hospitalUnidades;
        }
      });
      
      try {
        const userRef = doc(db, "users", user.uid);
        await setDoc(userRef, {
          config: {
            locaisAtendimento,
            hospitais,
            unidades
          }
        }, { merge: true });
        
        alert("Configurações salvas com sucesso!");
      } catch (error) {
        console.error("Erro ao salvar configurações:", error);
        alert("Erro ao salvar configurações. Tente novamente.");
      }
    }
  </script>
</body>
</html>
