<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GEF - Gerador de Evolução</title>
  <link rel="stylesheet" href="style-dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .gef-container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .selection-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .selection-group {
      margin-bottom: 15px;
    }
    
    .selection-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .selection-group select, 
    .selection-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    .selection-group button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .selection-group button:hover {
      background-color: #2980b9;
    }
    
    #listaPacientes {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    #listaPacientes li {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    #listaPacientes li button {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    #listaPacientes li button:hover {
      background-color: #c0392b;
    }
    
    #listaPacientes li button.selecionar {
      background-color: #2ecc71;
    }
    
    #listaPacientes li button.selecionar:hover {
      background-color: #27ae60;
    }
    
    #cadastroPaciente {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    #formEvolucao {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .form-row {
      margin-bottom: 15px;
    }
    
    .form-row label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .form-row input,
    .form-row textarea,
    .form-row select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    .form-row textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    #salvarEvolucao {
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    #salvarEvolucao:hover {
      background-color: #27ae60;
    }
    
    .paciente-info {
      font-weight: bold;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      color: #2c3e50;
    }

    .back-button {
      background-color: #95a5a6;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 15px;
    }

    .back-button:hover {
      background-color: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="gef-container">
    <button class="back-button" id="backToDashboard">
      <i class="fas fa-arrow-left"></i> Voltar ao Painel
    </button>
    
    <h2><i class="fas fa-file-medical"></i> Gerador de Evolução Fisioterapêutica</h2>
    
    <div class="selection-container">
      <div class="selection-group">
        <label for="localAtendimento">Local de Atendimento:</label>
        <select id="localAtendimento">
          <option value="" disabled selected>Selecione</option>
          <!-- Opções serão carregadas dinamicamente -->
        </select>
      </div>
      
      <div id="hospitalContainer" class="selection-group" style="display:none;">
        <label for="hospital">Hospital:</label>
        <select id="hospital">
          <option value="" disabled selected>Selecione</option>
          <!-- Opções serão carregadas dinamicamente -->
        </select>
      </div>
      
      <div id="unidadeContainer" class="selection-group" style="display:none;">
        <label for="unidade">Unidade:</label>
        <select id="unidade">
          <option value="" disabled selected>Selecione</option>
          <!-- Opções serão carregadas dinamicamente -->
        </select>
      </div>
      
      <div id="leitosContainer" class="selection-group" style="display:none;">
        <button id="btnAdicionarPaciente"><i class="fas fa-plus"></i> Adicionar Paciente</button>
        <h3>Pacientes:</h3>
        <ul id="listaPacientes"></ul>
      </div>
    </div>
    
    <div id="cadastroPaciente" class="selection-container">
      <h3>Cadastrar Novo Paciente</h3>
      <div class="selection-group">
        <label for="leitoPaciente">Número do Leito:</label>
        <input type="text" id="leitoPaciente" placeholder="Ex: 101">
      </div>
      <div class="selection-group">
        <label for="nomePaciente">Nome do Paciente:</label>
        <input type="text" id="nomePaciente" placeholder="Nome completo">
      </div>
      <button id="btnSalvarPaciente"><i class="fas fa-save"></i> Salvar</button>
      <button id="btnCancelarCadastro" style="background-color: #95a5a6; margin-left: 10px;"><i class="fas fa-times"></i> Cancelar</button>
    </div>
    
    <div id="formEvolucao">
      <div class="paciente-info" id="infoPaciente"></div>
      
      <div class="form-row">
        <label for="dataAtendimento">Data do Atendimento:</label>
        <input type="date" id="dataAtendimento">
      </div>
      
      <div class="form-row">
        <label for="queixaPrincipal">Queixa Principal:</label>
        <textarea id="queixaPrincipal"></textarea>
      </div>
      
      <div class="form-row">
        <label for="procedimentos">Procedimentos Realizados:</label>
        <textarea id="procedimentos"></textarea>
      </div>
      
      <div class="form-row">
        <label for="evolucao">Evolução:</label>
        <textarea id="evolucao"></textarea>
      </div>
      
      <div class="form-row">
        <label for="observacoes">Observações:</label>
        <textarea id="observacoes"></textarea>
      </div>
      
      <button id="salvarEvolucao"><i class="fas fa-save"></i> Salvar Evolução</button>
    </div>
  </div>

  <script type="module">
    import { app, auth } from './firebase-config.js';
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      setDoc, 
      updateDoc, 
      collection, 
      getDocs, 
      deleteDoc 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const db = getFirestore(app);
    let userConfig = {};

    // Elementos do DOM
    const localAtendimento = document.getElementById('localAtendimento');
    const hospitalContainer = document.getElementById('hospitalContainer');
    const hospitalSelect = document.getElementById('hospital');
    const unidadeContainer = document.getElementById('unidadeContainer');
    const unidadeSelect = document.getElementById('unidade');
    const leitosContainer = document.getElementById('leitosContainer');
    const listaPacientes = document.getElementById('listaPacientes');
    const cadastroPaciente = document.getElementById('cadastroPaciente');
    const formEvolucao = document.getElementById('formEvolucao');
    const btnAdicionarPaciente = document.getElementById('btnAdicionarPaciente');
    const btnSalvarPaciente = document.getElementById('btnSalvarPaciente');
    const btnCancelarCadastro = document.getElementById('btnCancelarCadastro');
    const salvarEvolucaoBtn = document.getElementById('salvarEvolucao');
    const backToDashboard = document.getElementById('backToDashboard');

    // Event Listeners
    backToDashboard.addEventListener('click', () => {
      window.parent.postMessage({ type: 'NAVIGATE_TO', section: 'dashboard' }, '*');
    });

    // Carrega configurações do usuário
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists() && userSnap.data().config) {
          userConfig = userSnap.data().config;
          setupLocaisAtendimento();
        }
      }
    });

    // Configura os locais de atendimento baseado nas configurações do usuário
    function setupLocaisAtendimento() {
      localAtendimento.innerHTML = '<option value="" disabled selected>Selecione</option>';
      
      if (userConfig.locaisAtendimento) {
        userConfig.locaisAtendimento.forEach(local => {
          const option = document.createElement('option');
          option.value = local;
          option.textContent = local;
          localAtendimento.appendChild(option);
        });
        
        // Seleciona automaticamente se houver apenas uma opção
        if (userConfig.locaisAtendimento.length === 1) {
          localAtendimento.value = userConfig.locaisAtendimento[0];
          localAtendimento.dispatchEvent(new Event('change'));
        }
      }
    }

    // Event Listeners continuam...
    localAtendimento.addEventListener('change', carregarHospitais);
    hospitalSelect.addEventListener('change', carregarUnidades);
    unidadeSelect.addEventListener('change', carregarLeitos);
    btnAdicionarPaciente.addEventListener('click', mostrarCadastroPaciente);
    btnSalvarPaciente.addEventListener('click', cadastrarPaciente);
    btnCancelarCadastro.addEventListener('click', () => {
      cadastroPaciente.style.display = 'none';
    });
    salvarEvolucaoBtn.addEventListener('click', salvarEvolucao);

    // Funções atualizadas para usar as configurações do usuário
    function carregarHospitais() {
      const local = localAtendimento.value;
      hospitalContainer.style.display = local === "Hospital" ? "block" : "none";
      
      if (local === "Hospital" && userConfig.hospitais) {
        hospitalSelect.innerHTML = '<option value="" disabled selected>Selecione</option>';
        
        userConfig.hospitais.forEach(hospital => {
          const option = document.createElement('option');
          option.value = hospital;
          option.textContent = hospital;
          hospitalSelect.appendChild(option);
        });
        
        // Seleciona automaticamente se houver apenas um hospital
        if (userConfig.hospitais.length === 1) {
          hospitalSelect.value = userConfig.hospitais[0];
          hospitalSelect.dispatchEvent(new Event('change'));
        }
      }
      
      unidadeContainer.style.display = "none";
      leitosContainer.style.display = "none";
      formEvolucao.style.display = "none";
    }

    function carregarUnidades() {
      const hospital = hospitalSelect.value;
      unidadeContainer.style.display = "block";
      unidadeSelect.innerHTML = '<option value="" disabled selected>Selecione</option>';
      
      if (userConfig.unidades && userConfig.unidades[hospital]) {
        // Agrupa por setor (UTI ou Enfermaria)
        const unidadesPorSetor = {};
        
        userConfig.unidades[hospital].forEach(unidade => {
          const setor = unidade.includes('UTI') ? 'UTI' : 'Enfermaria';
          if (!unidadesPorSetor[setor]) {
            unidadesPorSetor[setor] = [];
          }
          unidadesPorSetor[setor].push(unidade);
        });
        
        // Adiciona ao select organizado por setor
        for (const [setor, unidades] of Object.entries(unidadesPorSetor)) {
          const optgroup = document.createElement('optgroup');
          optgroup.label = setor;
          
          unidades.forEach(unidade => {
            const option = document.createElement('option');
            option.value = unidade;
            option.textContent = unidade;
            optgroup.appendChild(option);
          });
          
          unidadeSelect.appendChild(optgroup);
        }
        
        // Seleciona automaticamente se houver apenas uma unidade
        if (userConfig.unidades[hospital].length === 1) {
          unidadeSelect.value = userConfig.unidades[hospital][0];
          unidadeSelect.dispatchEvent(new Event('change'));
        }
      }
      
      leitosContainer.style.display = "none";
      formEvolucao.style.display = "none";
    }

    // ... (restante das funções permanecem iguais ao original)
    async function carregarLeitos() {
      const hospital = hospitalSelect.value;
      const unidade = unidadeSelect.value;
      
      leitosContainer.style.display = "block";
      await atualizarListaPacientes();
      formEvolucao.style.display = "none";
    }

    async function atualizarListaPacientes() {
      const hospital = hospitalSelect.value;
      const unidade = unidadeSelect.value;
      listaPacientes.innerHTML = "";
      
      try {
        const leitosRef = collection(db, "hospitais", hospital, "unidades", unidade, "leitos");
        const leitosSnap = await getDocs(leitosRef);
        
        if (leitosSnap.empty) {
          listaPacientes.innerHTML = "<li>Nenhum paciente cadastrado nesta unidade</li>";
          return;
        }
        
        leitosSnap.forEach((docSnap) => {
          const dados = docSnap.data();
          const li = document.createElement("li");
          li.innerHTML = `
            <span><strong>Leito ${docSnap.id}</strong>: ${dados.nome || 'Sem nome'}</span>
            <div>
              <button class="selecionar" data-hospital="${hospital}" data-unidade="${unidade}" data-leito="${docSnap.id}">
                <i class="fas fa-edit"></i> Editar
              </button>
              <button class="excluir" data-hospital="${hospital}" data-unidade="${unidade}" data-leito="${docSnap.id}">
                <i class="fas fa-trash"></i> Excluir
              </button>
            </div>
          `;
          listaPacientes.appendChild(li);
        });

        // Adiciona event listeners aos novos botões
        document.querySelectorAll('.selecionar').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const { hospital, unidade, leito } = e.target.dataset;
            carregarEvolucao(hospital, unidade, leito);
          });
        });

        document.querySelectorAll('.excluir').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const { hospital, unidade, leito } = e.target.dataset;
            removerPaciente(hospital, unidade, leito);
          });
        });

      } catch (error) {
        console.error("Erro ao carregar pacientes:", error);
        listaPacientes.innerHTML = "<li>Erro ao carregar lista de pacientes</li>";
      }
    }

    function mostrarCadastroPaciente() {
      cadastroPaciente.style.display = "block";
      document.getElementById("leitoPaciente").value = "";
      document.getElementById("nomePaciente").value = "";
    }

    async function cadastrarPaciente() {
      const hospital = hospitalSelect.value;
      const unidade = unidadeSelect.value;
      const leito = document.getElementById("leitoPaciente").value;
      const nome = document.getElementById("nomePaciente").value;

      if (!leito || !nome) {
        alert("Preencha todos os campos.");
        return;
      }

      try {
        const docRef = doc(db, "hospitais", hospital, "unidades", unidade, "leitos", leito);
        await setDoc(docRef, { 
          nome,
          evolucao: {} 
        });
        
        alert("Paciente cadastrado com sucesso!");
        cadastroPaciente.style.display = "none";
        await atualizarListaPacientes();
      } catch (error) {
        console.error("Erro ao cadastrar paciente:", error);
        alert("Erro ao cadastrar paciente. Tente novamente.");
      }
    }

    async function removerPaciente(hospital, unidade, leito) {
      if (!confirm(`Deseja realmente remover o paciente do leito ${leito}?`)) {
        return;
      }

      try {
        const docRef = doc(db, "hospitais", hospital, "unidades", unidade, "leitos", leito);
        await deleteDoc(docRef);
        await atualizarListaPacientes();
      } catch (error) {
        console.error("Erro ao remover paciente:", error);
        alert("Erro ao remover paciente. Tente novamente.");
      }
    }

    async function carregarEvolucao(hospital, unidade, leito) {
      try {
        const docRef = doc(db, "hospitais", hospital, "unidades", unidade, "leitos", leito);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) {
          alert("Paciente não encontrado.");
          return;
        }
        
        const dados = docSnap.data();
        document.getElementById("infoPaciente").innerHTML = `
          <i class="fas fa-procedures"></i> Paciente: <strong>${dados.nome || 'Sem nome'}</strong> | 
          <i class="fas fa-hospital"></i> Hospital: <strong>${hospital}</strong> | 
          <i class="fas fa-door-open"></i> Unidade: <strong>${unidade}</strong> | 
          <i class="fas fa-bed"></i> Leito: <strong>${leito}</strong>
        `;
        
        formEvolucao.style.display = "block";
        formEvolucao.dataset.hospital = hospital;
        formEvolucao.dataset.unidade = unidade;
        formEvolucao.dataset.leito = leito;
        
        // Preenche os campos se já existirem dados
        if (dados.evolucao) {
          document.getElementById("dataAtendimento").value = dados.evolucao.dataAtendimento || '';
          document.getElementById("queixaPrincipal").value = dados.evolucao.queixaPrincipal || '';
          document.getElementById("procedimentos").value = dados.evolucao.procedimentos || '';
          document.getElementById("evolucao").value = dados.evolucao.evolucao || '';
          document.getElementById("observacoes").value = dados.evolucao.observacoes || '';
        } else {
          // Limpa os campos se não houver dados
          document.getElementById("dataAtendimento").value = '';
          document.getElementById("queixaPrincipal").value = '';
          document.getElementById("procedimentos").value = '';
          document.getElementById("evolucao").value = '';
          document.getElementById("observacoes").value = '';
        }
        
        formEvolucao.scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error("Erro ao carregar evolução:", error);
        alert("Erro ao carregar dados do paciente. Tente novamente.");
      }
    }

    async function salvarEvolucao() {
      const hospital = formEvolucao.dataset.hospital;
      const unidade = formEvolucao.dataset.unidade;
      const leito = formEvolucao.dataset.leito;
      
      if (!hospital || !unidade || !leito) {
        alert("Selecione um paciente antes de salvar.");
        return;
      }
      
      try {
        const evolucao = {
          dataAtendimento: document.getElementById("dataAtendimento").value,
          queixaPrincipal: document.getElementById("queixaPrincipal").value,
          procedimentos: document.getElementById("procedimentos").value,
          evolucao: document.getElementById("evolucao").value,
          observacoes: document.getElementById("observacoes").value,
          dataRegistro: new Date().toISOString()
        };
        
        const docRef = doc(db, "hospitais", hospital, "unidades", unidade, "leitos", leito);
        await updateDoc(docRef, { evolucao });
        
        alert("Evolução salva com sucesso!");
      } catch (error) {
        console.error("Erro ao salvar evolução:", error);
        alert("Erro ao salvar evolução. Tente novamente.");
      }
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
      // Configura o evento de submit do formulário para evitar recarregamento da página
      const forms = document.querySelectorAll('form');
      forms.forEach(form => {
        form.addEventListener('submit', (e) => e.preventDefault());
      });
    });
  </script>
</body>
</html>
